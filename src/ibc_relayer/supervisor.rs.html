<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Source of the Rust file `crates/relayer/src/supervisor.rs`."><meta name="keywords" content="rust, rustlang, rust-lang"><title>supervisor.rs - source</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceSerif4-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../FiraSans-Regular.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../FiraSans-Medium.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceCodePro-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceSerif4-Bold.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceCodePro-Semibold.ttf.woff2"><link rel="stylesheet" href="../../normalize.css"><link rel="stylesheet" href="../../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" href="../../ayu.css" disabled><link rel="stylesheet" href="../../dark.css" disabled><link rel="stylesheet" href="../../light.css" id="themeStyle"><script id="default-settings" ></script><script src="../../storage.js"></script><script defer src="../../source-script.js"></script><script defer src="../../source-files.js"></script><script defer src="../../main.js"></script><noscript><link rel="stylesheet" href="../../noscript.css"></noscript><link rel="alternate icon" type="image/png" href="../../favicon-16x16.png"><link rel="alternate icon" type="image/png" href="../../favicon-32x32.png"><link rel="icon" type="image/svg+xml" href="../../favicon.svg"></head><body class="rustdoc source"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="sidebar-logo" href="../../ibc_relayer/index.html"><div class="logo-container"><img class="rust-logo" src="../../rust-logo.svg" alt="logo"></div></a><h2 class="location"></h2></nav><nav class="sidebar"><a class="sidebar-logo" href="../../ibc_relayer/index.html"><div class="logo-container"><img class="rust-logo" src="../../rust-logo.svg" alt="logo"></div></a></nav><main><div class="width-limiter"><div class="sub-container"><a class="sub-logo-container" href="../../ibc_relayer/index.html"><img class="rust-logo" src="../../rust-logo.svg" alt="logo"></a><nav class="sub"><form class="search-form"><div class="search-container"><span></span><input class="search-input" name="search" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" title="help" tabindex="-1"><button type="button">?</button></div><div id="settings-menu" tabindex="-1"><a href="../../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../../wheel.svg"></a></div></div></form></nav></div><section id="main-content" class="content"><div class="example-wrap"><pre class="line-numbers"><span id="1">1</span>
<span id="2">2</span>
<span id="3">3</span>
<span id="4">4</span>
<span id="5">5</span>
<span id="6">6</span>
<span id="7">7</span>
<span id="8">8</span>
<span id="9">9</span>
<span id="10">10</span>
<span id="11">11</span>
<span id="12">12</span>
<span id="13">13</span>
<span id="14">14</span>
<span id="15">15</span>
<span id="16">16</span>
<span id="17">17</span>
<span id="18">18</span>
<span id="19">19</span>
<span id="20">20</span>
<span id="21">21</span>
<span id="22">22</span>
<span id="23">23</span>
<span id="24">24</span>
<span id="25">25</span>
<span id="26">26</span>
<span id="27">27</span>
<span id="28">28</span>
<span id="29">29</span>
<span id="30">30</span>
<span id="31">31</span>
<span id="32">32</span>
<span id="33">33</span>
<span id="34">34</span>
<span id="35">35</span>
<span id="36">36</span>
<span id="37">37</span>
<span id="38">38</span>
<span id="39">39</span>
<span id="40">40</span>
<span id="41">41</span>
<span id="42">42</span>
<span id="43">43</span>
<span id="44">44</span>
<span id="45">45</span>
<span id="46">46</span>
<span id="47">47</span>
<span id="48">48</span>
<span id="49">49</span>
<span id="50">50</span>
<span id="51">51</span>
<span id="52">52</span>
<span id="53">53</span>
<span id="54">54</span>
<span id="55">55</span>
<span id="56">56</span>
<span id="57">57</span>
<span id="58">58</span>
<span id="59">59</span>
<span id="60">60</span>
<span id="61">61</span>
<span id="62">62</span>
<span id="63">63</span>
<span id="64">64</span>
<span id="65">65</span>
<span id="66">66</span>
<span id="67">67</span>
<span id="68">68</span>
<span id="69">69</span>
<span id="70">70</span>
<span id="71">71</span>
<span id="72">72</span>
<span id="73">73</span>
<span id="74">74</span>
<span id="75">75</span>
<span id="76">76</span>
<span id="77">77</span>
<span id="78">78</span>
<span id="79">79</span>
<span id="80">80</span>
<span id="81">81</span>
<span id="82">82</span>
<span id="83">83</span>
<span id="84">84</span>
<span id="85">85</span>
<span id="86">86</span>
<span id="87">87</span>
<span id="88">88</span>
<span id="89">89</span>
<span id="90">90</span>
<span id="91">91</span>
<span id="92">92</span>
<span id="93">93</span>
<span id="94">94</span>
<span id="95">95</span>
<span id="96">96</span>
<span id="97">97</span>
<span id="98">98</span>
<span id="99">99</span>
<span id="100">100</span>
<span id="101">101</span>
<span id="102">102</span>
<span id="103">103</span>
<span id="104">104</span>
<span id="105">105</span>
<span id="106">106</span>
<span id="107">107</span>
<span id="108">108</span>
<span id="109">109</span>
<span id="110">110</span>
<span id="111">111</span>
<span id="112">112</span>
<span id="113">113</span>
<span id="114">114</span>
<span id="115">115</span>
<span id="116">116</span>
<span id="117">117</span>
<span id="118">118</span>
<span id="119">119</span>
<span id="120">120</span>
<span id="121">121</span>
<span id="122">122</span>
<span id="123">123</span>
<span id="124">124</span>
<span id="125">125</span>
<span id="126">126</span>
<span id="127">127</span>
<span id="128">128</span>
<span id="129">129</span>
<span id="130">130</span>
<span id="131">131</span>
<span id="132">132</span>
<span id="133">133</span>
<span id="134">134</span>
<span id="135">135</span>
<span id="136">136</span>
<span id="137">137</span>
<span id="138">138</span>
<span id="139">139</span>
<span id="140">140</span>
<span id="141">141</span>
<span id="142">142</span>
<span id="143">143</span>
<span id="144">144</span>
<span id="145">145</span>
<span id="146">146</span>
<span id="147">147</span>
<span id="148">148</span>
<span id="149">149</span>
<span id="150">150</span>
<span id="151">151</span>
<span id="152">152</span>
<span id="153">153</span>
<span id="154">154</span>
<span id="155">155</span>
<span id="156">156</span>
<span id="157">157</span>
<span id="158">158</span>
<span id="159">159</span>
<span id="160">160</span>
<span id="161">161</span>
<span id="162">162</span>
<span id="163">163</span>
<span id="164">164</span>
<span id="165">165</span>
<span id="166">166</span>
<span id="167">167</span>
<span id="168">168</span>
<span id="169">169</span>
<span id="170">170</span>
<span id="171">171</span>
<span id="172">172</span>
<span id="173">173</span>
<span id="174">174</span>
<span id="175">175</span>
<span id="176">176</span>
<span id="177">177</span>
<span id="178">178</span>
<span id="179">179</span>
<span id="180">180</span>
<span id="181">181</span>
<span id="182">182</span>
<span id="183">183</span>
<span id="184">184</span>
<span id="185">185</span>
<span id="186">186</span>
<span id="187">187</span>
<span id="188">188</span>
<span id="189">189</span>
<span id="190">190</span>
<span id="191">191</span>
<span id="192">192</span>
<span id="193">193</span>
<span id="194">194</span>
<span id="195">195</span>
<span id="196">196</span>
<span id="197">197</span>
<span id="198">198</span>
<span id="199">199</span>
<span id="200">200</span>
<span id="201">201</span>
<span id="202">202</span>
<span id="203">203</span>
<span id="204">204</span>
<span id="205">205</span>
<span id="206">206</span>
<span id="207">207</span>
<span id="208">208</span>
<span id="209">209</span>
<span id="210">210</span>
<span id="211">211</span>
<span id="212">212</span>
<span id="213">213</span>
<span id="214">214</span>
<span id="215">215</span>
<span id="216">216</span>
<span id="217">217</span>
<span id="218">218</span>
<span id="219">219</span>
<span id="220">220</span>
<span id="221">221</span>
<span id="222">222</span>
<span id="223">223</span>
<span id="224">224</span>
<span id="225">225</span>
<span id="226">226</span>
<span id="227">227</span>
<span id="228">228</span>
<span id="229">229</span>
<span id="230">230</span>
<span id="231">231</span>
<span id="232">232</span>
<span id="233">233</span>
<span id="234">234</span>
<span id="235">235</span>
<span id="236">236</span>
<span id="237">237</span>
<span id="238">238</span>
<span id="239">239</span>
<span id="240">240</span>
<span id="241">241</span>
<span id="242">242</span>
<span id="243">243</span>
<span id="244">244</span>
<span id="245">245</span>
<span id="246">246</span>
<span id="247">247</span>
<span id="248">248</span>
<span id="249">249</span>
<span id="250">250</span>
<span id="251">251</span>
<span id="252">252</span>
<span id="253">253</span>
<span id="254">254</span>
<span id="255">255</span>
<span id="256">256</span>
<span id="257">257</span>
<span id="258">258</span>
<span id="259">259</span>
<span id="260">260</span>
<span id="261">261</span>
<span id="262">262</span>
<span id="263">263</span>
<span id="264">264</span>
<span id="265">265</span>
<span id="266">266</span>
<span id="267">267</span>
<span id="268">268</span>
<span id="269">269</span>
<span id="270">270</span>
<span id="271">271</span>
<span id="272">272</span>
<span id="273">273</span>
<span id="274">274</span>
<span id="275">275</span>
<span id="276">276</span>
<span id="277">277</span>
<span id="278">278</span>
<span id="279">279</span>
<span id="280">280</span>
<span id="281">281</span>
<span id="282">282</span>
<span id="283">283</span>
<span id="284">284</span>
<span id="285">285</span>
<span id="286">286</span>
<span id="287">287</span>
<span id="288">288</span>
<span id="289">289</span>
<span id="290">290</span>
<span id="291">291</span>
<span id="292">292</span>
<span id="293">293</span>
<span id="294">294</span>
<span id="295">295</span>
<span id="296">296</span>
<span id="297">297</span>
<span id="298">298</span>
<span id="299">299</span>
<span id="300">300</span>
<span id="301">301</span>
<span id="302">302</span>
<span id="303">303</span>
<span id="304">304</span>
<span id="305">305</span>
<span id="306">306</span>
<span id="307">307</span>
<span id="308">308</span>
<span id="309">309</span>
<span id="310">310</span>
<span id="311">311</span>
<span id="312">312</span>
<span id="313">313</span>
<span id="314">314</span>
<span id="315">315</span>
<span id="316">316</span>
<span id="317">317</span>
<span id="318">318</span>
<span id="319">319</span>
<span id="320">320</span>
<span id="321">321</span>
<span id="322">322</span>
<span id="323">323</span>
<span id="324">324</span>
<span id="325">325</span>
<span id="326">326</span>
<span id="327">327</span>
<span id="328">328</span>
<span id="329">329</span>
<span id="330">330</span>
<span id="331">331</span>
<span id="332">332</span>
<span id="333">333</span>
<span id="334">334</span>
<span id="335">335</span>
<span id="336">336</span>
<span id="337">337</span>
<span id="338">338</span>
<span id="339">339</span>
<span id="340">340</span>
<span id="341">341</span>
<span id="342">342</span>
<span id="343">343</span>
<span id="344">344</span>
<span id="345">345</span>
<span id="346">346</span>
<span id="347">347</span>
<span id="348">348</span>
<span id="349">349</span>
<span id="350">350</span>
<span id="351">351</span>
<span id="352">352</span>
<span id="353">353</span>
<span id="354">354</span>
<span id="355">355</span>
<span id="356">356</span>
<span id="357">357</span>
<span id="358">358</span>
<span id="359">359</span>
<span id="360">360</span>
<span id="361">361</span>
<span id="362">362</span>
<span id="363">363</span>
<span id="364">364</span>
<span id="365">365</span>
<span id="366">366</span>
<span id="367">367</span>
<span id="368">368</span>
<span id="369">369</span>
<span id="370">370</span>
<span id="371">371</span>
<span id="372">372</span>
<span id="373">373</span>
<span id="374">374</span>
<span id="375">375</span>
<span id="376">376</span>
<span id="377">377</span>
<span id="378">378</span>
<span id="379">379</span>
<span id="380">380</span>
<span id="381">381</span>
<span id="382">382</span>
<span id="383">383</span>
<span id="384">384</span>
<span id="385">385</span>
<span id="386">386</span>
<span id="387">387</span>
<span id="388">388</span>
<span id="389">389</span>
<span id="390">390</span>
<span id="391">391</span>
<span id="392">392</span>
<span id="393">393</span>
<span id="394">394</span>
<span id="395">395</span>
<span id="396">396</span>
<span id="397">397</span>
<span id="398">398</span>
<span id="399">399</span>
<span id="400">400</span>
<span id="401">401</span>
<span id="402">402</span>
<span id="403">403</span>
<span id="404">404</span>
<span id="405">405</span>
<span id="406">406</span>
<span id="407">407</span>
<span id="408">408</span>
<span id="409">409</span>
<span id="410">410</span>
<span id="411">411</span>
<span id="412">412</span>
<span id="413">413</span>
<span id="414">414</span>
<span id="415">415</span>
<span id="416">416</span>
<span id="417">417</span>
<span id="418">418</span>
<span id="419">419</span>
<span id="420">420</span>
<span id="421">421</span>
<span id="422">422</span>
<span id="423">423</span>
<span id="424">424</span>
<span id="425">425</span>
<span id="426">426</span>
<span id="427">427</span>
<span id="428">428</span>
<span id="429">429</span>
<span id="430">430</span>
<span id="431">431</span>
<span id="432">432</span>
<span id="433">433</span>
<span id="434">434</span>
<span id="435">435</span>
<span id="436">436</span>
<span id="437">437</span>
<span id="438">438</span>
<span id="439">439</span>
<span id="440">440</span>
<span id="441">441</span>
<span id="442">442</span>
<span id="443">443</span>
<span id="444">444</span>
<span id="445">445</span>
<span id="446">446</span>
<span id="447">447</span>
<span id="448">448</span>
<span id="449">449</span>
<span id="450">450</span>
<span id="451">451</span>
<span id="452">452</span>
<span id="453">453</span>
<span id="454">454</span>
<span id="455">455</span>
<span id="456">456</span>
<span id="457">457</span>
<span id="458">458</span>
<span id="459">459</span>
<span id="460">460</span>
<span id="461">461</span>
<span id="462">462</span>
<span id="463">463</span>
<span id="464">464</span>
<span id="465">465</span>
<span id="466">466</span>
<span id="467">467</span>
<span id="468">468</span>
<span id="469">469</span>
<span id="470">470</span>
<span id="471">471</span>
<span id="472">472</span>
<span id="473">473</span>
<span id="474">474</span>
<span id="475">475</span>
<span id="476">476</span>
<span id="477">477</span>
<span id="478">478</span>
<span id="479">479</span>
<span id="480">480</span>
<span id="481">481</span>
<span id="482">482</span>
<span id="483">483</span>
<span id="484">484</span>
<span id="485">485</span>
<span id="486">486</span>
<span id="487">487</span>
<span id="488">488</span>
<span id="489">489</span>
<span id="490">490</span>
<span id="491">491</span>
<span id="492">492</span>
<span id="493">493</span>
<span id="494">494</span>
<span id="495">495</span>
<span id="496">496</span>
<span id="497">497</span>
<span id="498">498</span>
<span id="499">499</span>
<span id="500">500</span>
<span id="501">501</span>
<span id="502">502</span>
<span id="503">503</span>
<span id="504">504</span>
<span id="505">505</span>
<span id="506">506</span>
<span id="507">507</span>
<span id="508">508</span>
<span id="509">509</span>
<span id="510">510</span>
<span id="511">511</span>
<span id="512">512</span>
<span id="513">513</span>
<span id="514">514</span>
<span id="515">515</span>
<span id="516">516</span>
<span id="517">517</span>
<span id="518">518</span>
<span id="519">519</span>
<span id="520">520</span>
<span id="521">521</span>
<span id="522">522</span>
<span id="523">523</span>
<span id="524">524</span>
<span id="525">525</span>
<span id="526">526</span>
<span id="527">527</span>
<span id="528">528</span>
<span id="529">529</span>
<span id="530">530</span>
<span id="531">531</span>
<span id="532">532</span>
<span id="533">533</span>
<span id="534">534</span>
<span id="535">535</span>
<span id="536">536</span>
<span id="537">537</span>
<span id="538">538</span>
<span id="539">539</span>
<span id="540">540</span>
<span id="541">541</span>
<span id="542">542</span>
<span id="543">543</span>
<span id="544">544</span>
<span id="545">545</span>
<span id="546">546</span>
<span id="547">547</span>
<span id="548">548</span>
<span id="549">549</span>
<span id="550">550</span>
<span id="551">551</span>
<span id="552">552</span>
<span id="553">553</span>
<span id="554">554</span>
<span id="555">555</span>
<span id="556">556</span>
<span id="557">557</span>
<span id="558">558</span>
<span id="559">559</span>
<span id="560">560</span>
<span id="561">561</span>
<span id="562">562</span>
<span id="563">563</span>
<span id="564">564</span>
<span id="565">565</span>
<span id="566">566</span>
<span id="567">567</span>
<span id="568">568</span>
<span id="569">569</span>
<span id="570">570</span>
<span id="571">571</span>
<span id="572">572</span>
<span id="573">573</span>
<span id="574">574</span>
<span id="575">575</span>
<span id="576">576</span>
<span id="577">577</span>
<span id="578">578</span>
<span id="579">579</span>
<span id="580">580</span>
<span id="581">581</span>
<span id="582">582</span>
<span id="583">583</span>
<span id="584">584</span>
<span id="585">585</span>
<span id="586">586</span>
<span id="587">587</span>
<span id="588">588</span>
<span id="589">589</span>
<span id="590">590</span>
<span id="591">591</span>
<span id="592">592</span>
<span id="593">593</span>
<span id="594">594</span>
<span id="595">595</span>
<span id="596">596</span>
<span id="597">597</span>
<span id="598">598</span>
<span id="599">599</span>
<span id="600">600</span>
<span id="601">601</span>
<span id="602">602</span>
<span id="603">603</span>
<span id="604">604</span>
<span id="605">605</span>
<span id="606">606</span>
<span id="607">607</span>
<span id="608">608</span>
<span id="609">609</span>
<span id="610">610</span>
<span id="611">611</span>
<span id="612">612</span>
<span id="613">613</span>
<span id="614">614</span>
<span id="615">615</span>
<span id="616">616</span>
<span id="617">617</span>
<span id="618">618</span>
<span id="619">619</span>
<span id="620">620</span>
<span id="621">621</span>
<span id="622">622</span>
<span id="623">623</span>
<span id="624">624</span>
<span id="625">625</span>
<span id="626">626</span>
<span id="627">627</span>
<span id="628">628</span>
<span id="629">629</span>
<span id="630">630</span>
<span id="631">631</span>
<span id="632">632</span>
<span id="633">633</span>
<span id="634">634</span>
<span id="635">635</span>
<span id="636">636</span>
<span id="637">637</span>
<span id="638">638</span>
<span id="639">639</span>
<span id="640">640</span>
<span id="641">641</span>
<span id="642">642</span>
<span id="643">643</span>
<span id="644">644</span>
<span id="645">645</span>
<span id="646">646</span>
<span id="647">647</span>
<span id="648">648</span>
<span id="649">649</span>
<span id="650">650</span>
<span id="651">651</span>
<span id="652">652</span>
<span id="653">653</span>
<span id="654">654</span>
<span id="655">655</span>
<span id="656">656</span>
<span id="657">657</span>
<span id="658">658</span>
<span id="659">659</span>
<span id="660">660</span>
<span id="661">661</span>
<span id="662">662</span>
<span id="663">663</span>
<span id="664">664</span>
<span id="665">665</span>
<span id="666">666</span>
<span id="667">667</span>
<span id="668">668</span>
<span id="669">669</span>
<span id="670">670</span>
<span id="671">671</span>
<span id="672">672</span>
<span id="673">673</span>
<span id="674">674</span>
<span id="675">675</span>
<span id="676">676</span>
<span id="677">677</span>
<span id="678">678</span>
<span id="679">679</span>
<span id="680">680</span>
<span id="681">681</span>
<span id="682">682</span>
<span id="683">683</span>
<span id="684">684</span>
<span id="685">685</span>
<span id="686">686</span>
<span id="687">687</span>
<span id="688">688</span>
<span id="689">689</span>
<span id="690">690</span>
<span id="691">691</span>
<span id="692">692</span>
<span id="693">693</span>
<span id="694">694</span>
<span id="695">695</span>
<span id="696">696</span>
<span id="697">697</span>
<span id="698">698</span>
<span id="699">699</span>
<span id="700">700</span>
<span id="701">701</span>
<span id="702">702</span>
<span id="703">703</span>
<span id="704">704</span>
<span id="705">705</span>
<span id="706">706</span>
<span id="707">707</span>
<span id="708">708</span>
<span id="709">709</span>
<span id="710">710</span>
<span id="711">711</span>
<span id="712">712</span>
<span id="713">713</span>
<span id="714">714</span>
<span id="715">715</span>
<span id="716">716</span>
<span id="717">717</span>
<span id="718">718</span>
<span id="719">719</span>
<span id="720">720</span>
<span id="721">721</span>
<span id="722">722</span>
<span id="723">723</span>
<span id="724">724</span>
<span id="725">725</span>
<span id="726">726</span>
<span id="727">727</span>
<span id="728">728</span>
<span id="729">729</span>
<span id="730">730</span>
<span id="731">731</span>
<span id="732">732</span>
<span id="733">733</span>
<span id="734">734</span>
<span id="735">735</span>
<span id="736">736</span>
<span id="737">737</span>
<span id="738">738</span>
<span id="739">739</span>
<span id="740">740</span>
<span id="741">741</span>
<span id="742">742</span>
<span id="743">743</span>
<span id="744">744</span>
<span id="745">745</span>
<span id="746">746</span>
<span id="747">747</span>
<span id="748">748</span>
<span id="749">749</span>
<span id="750">750</span>
<span id="751">751</span>
<span id="752">752</span>
<span id="753">753</span>
<span id="754">754</span>
<span id="755">755</span>
<span id="756">756</span>
<span id="757">757</span>
<span id="758">758</span>
<span id="759">759</span>
<span id="760">760</span>
<span id="761">761</span>
<span id="762">762</span>
<span id="763">763</span>
<span id="764">764</span>
<span id="765">765</span>
<span id="766">766</span>
<span id="767">767</span>
<span id="768">768</span>
<span id="769">769</span>
<span id="770">770</span>
<span id="771">771</span>
<span id="772">772</span>
<span id="773">773</span>
<span id="774">774</span>
<span id="775">775</span>
<span id="776">776</span>
<span id="777">777</span>
<span id="778">778</span>
<span id="779">779</span>
<span id="780">780</span>
<span id="781">781</span>
<span id="782">782</span>
<span id="783">783</span>
<span id="784">784</span>
<span id="785">785</span>
<span id="786">786</span>
<span id="787">787</span>
<span id="788">788</span>
<span id="789">789</span>
<span id="790">790</span>
<span id="791">791</span>
<span id="792">792</span>
<span id="793">793</span>
<span id="794">794</span>
<span id="795">795</span>
<span id="796">796</span>
<span id="797">797</span>
<span id="798">798</span>
<span id="799">799</span>
<span id="800">800</span>
<span id="801">801</span>
<span id="802">802</span>
<span id="803">803</span>
<span id="804">804</span>
<span id="805">805</span>
<span id="806">806</span>
<span id="807">807</span>
<span id="808">808</span>
<span id="809">809</span>
<span id="810">810</span>
<span id="811">811</span>
<span id="812">812</span>
<span id="813">813</span>
<span id="814">814</span>
<span id="815">815</span>
<span id="816">816</span>
<span id="817">817</span>
<span id="818">818</span>
<span id="819">819</span>
<span id="820">820</span>
<span id="821">821</span>
<span id="822">822</span>
<span id="823">823</span>
<span id="824">824</span>
<span id="825">825</span>
<span id="826">826</span>
<span id="827">827</span>
<span id="828">828</span>
<span id="829">829</span>
<span id="830">830</span>
<span id="831">831</span>
<span id="832">832</span>
<span id="833">833</span>
<span id="834">834</span>
<span id="835">835</span>
<span id="836">836</span>
<span id="837">837</span>
<span id="838">838</span>
<span id="839">839</span>
<span id="840">840</span>
<span id="841">841</span>
<span id="842">842</span>
<span id="843">843</span>
<span id="844">844</span>
<span id="845">845</span>
<span id="846">846</span>
<span id="847">847</span>
<span id="848">848</span>
<span id="849">849</span>
<span id="850">850</span>
<span id="851">851</span>
<span id="852">852</span>
<span id="853">853</span>
<span id="854">854</span>
<span id="855">855</span>
<span id="856">856</span>
<span id="857">857</span>
<span id="858">858</span>
</pre><pre class="rust"><code><span class="kw">use </span>alloc::collections::btree_map::BTreeMap <span class="kw">as </span>HashMap;
<span class="kw">use </span>alloc::sync::Arc;
<span class="kw">use </span>core::convert::Infallible;
<span class="kw">use </span>core::ops::Deref;
<span class="kw">use </span>core::time::Duration;
<span class="kw">use </span>std::sync::RwLock;

<span class="kw">use </span>crossbeam_channel::{unbounded, Receiver, Sender};
<span class="kw">use </span>itertools::Itertools;
<span class="kw">use </span>tracing::{debug, error, error_span, info, instrument, trace, warn};

<span class="kw">use </span>ibc_relayer_types::{
    core::ics24_host::identifier::{ChainId, ChannelId, PortId},
    events::IbcEvent,
    Height,
};

<span class="kw">use crate</span>::{
    chain::{endpoint::HealthCheck, handle::ChainHandle, tracking::TrackingId},
    config::Config,
    event::{
        monitor::{<span class="self">self</span>, Error <span class="kw">as </span>EventError, ErrorDetail <span class="kw">as </span>EventErrorDetail, EventBatch},
        IbcEventWithHeight,
    },
    object::Object,
    registry::{Registry, SharedRegistry},
    rest,
    supervisor::scan::ScanMode,
    telemetry,
    util::{
        lock::LockExt,
        task::{spawn_background_task, Next, TaskError, TaskHandle},
    },
    worker::WorkerMap,
};

<span class="kw">pub mod </span>client_state_filter;
<span class="kw">use </span>client_state_filter::{FilterPolicy, Permission};

<span class="kw">pub mod </span>error;
<span class="kw">pub use </span>error::{Error, ErrorDetail};

<span class="kw">pub mod </span>dump_state;
<span class="kw">use </span>dump_state::SupervisorState;

<span class="kw">pub mod </span>scan;
<span class="kw">pub mod </span>spawn;

<span class="kw">pub mod </span>cmd;
<span class="kw">use </span>cmd::SupervisorCmd;

<span class="kw">use </span><span class="self">self</span>::{scan::ChainScanner, spawn::SpawnContext};

<span class="kw">type </span>ArcBatch = Arc&lt;monitor::Result&lt;EventBatch&gt;&gt;;
<span class="kw">type </span>Subscription = Receiver&lt;ArcBatch&gt;;

<span class="doccomment">/**
    A wrapper around the SupervisorCmd sender so that we can
    send stop signal to the supervisor before stopping the
    chain drivers to prevent the supervisor from raising
    errors caused by closed connections.
*/
</span><span class="kw">pub struct </span>SupervisorHandle {
    <span class="kw">pub </span>sender: Sender&lt;SupervisorCmd&gt;,
    tasks: Vec&lt;TaskHandle&gt;,
}

<span class="doccomment">/// Options for the supervisor
</span><span class="attribute">#[derive(Debug)]
</span><span class="kw">pub struct </span>SupervisorOptions {
    <span class="doccomment">/// Perform a health check of all chains we connect to
    </span><span class="kw">pub </span>health_check: bool,

    <span class="doccomment">/// Force a full scan of the chains for clients, connections, and channels,
    /// even when an allow list is configured for a chain and the full scan could
    /// be omitted.
    </span><span class="kw">pub </span>force_full_scan: bool,
}

<span class="doccomment">/**
   Spawn a supervisor for testing purpose using the provided
   [`Config`] and [`SharedRegistry`]. Returns a
   [`SupervisorHandle`] that stops the supervisor when the
   value is dropped.
*/
</span><span class="kw">pub fn </span>spawn_supervisor(
    config: Config,
    registry: SharedRegistry&lt;<span class="kw">impl </span>ChainHandle&gt;,
    rest_rx: <span class="prelude-ty">Option</span>&lt;rest::Receiver&gt;,
    options: SupervisorOptions,
) -&gt; <span class="prelude-ty">Result</span>&lt;SupervisorHandle, Error&gt; {
    <span class="kw">let </span>(sender, receiver) = unbounded();

    <span class="kw">let </span>tasks = spawn_supervisor_tasks(config, registry, rest_rx, receiver, options)<span class="question-mark">?</span>;

    <span class="prelude-val">Ok</span>(SupervisorHandle { sender, tasks })
}

<span class="kw">impl </span>SupervisorHandle {
    <span class="doccomment">/**
       Explicitly stop the running supervisor. This is useful in tests where
       the supervisor has to be stopped and restarted explicitly.

       Note that after stopping the supervisor, the only way to restart it
       is by respawning a new supervisor using [`spawn_supervisor`].
    */
    </span><span class="kw">pub fn </span>shutdown(<span class="self">self</span>) {
        <span class="kw">for </span>task <span class="kw">in </span><span class="self">self</span>.tasks {
            <span class="comment">// Send the shutdown signals in parallel
            </span>task.shutdown();
        }
        <span class="comment">// Dropping the tasks will cause this to block until all tasks
        // are terminated.
    </span>}

    <span class="kw">pub fn </span>wait(<span class="self">self</span>) {
        <span class="kw">for </span>task <span class="kw">in </span><span class="self">self</span>.tasks {
            task.join();
        }
    }
}

<span class="kw">pub fn </span>spawn_supervisor_tasks&lt;Chain: ChainHandle&gt;(
    config: Config,
    registry: SharedRegistry&lt;Chain&gt;,
    rest_rx: <span class="prelude-ty">Option</span>&lt;rest::Receiver&gt;,
    cmd_rx: Receiver&lt;SupervisorCmd&gt;,
    options: SupervisorOptions,
) -&gt; <span class="prelude-ty">Result</span>&lt;Vec&lt;TaskHandle&gt;, Error&gt; {
    <span class="kw">if </span>options.health_check {
        health_check(<span class="kw-2">&amp;</span>config, <span class="kw-2">&amp;mut </span>registry.write());
    }

    <span class="kw">let </span>workers = Arc::new(RwLock::new(WorkerMap::new()));
    <span class="kw">let </span>client_state_filter = Arc::new(RwLock::new(FilterPolicy::default()));

    <span class="kw">let </span>scan = chain_scanner(
        <span class="kw-2">&amp;</span>config,
        <span class="kw-2">&amp;mut </span>registry.write(),
        <span class="kw-2">&amp;mut </span>client_state_filter.acquire_write(),
        <span class="kw">if </span>options.force_full_scan {
            ScanMode::Full
        } <span class="kw">else </span>{
            ScanMode::Auto
        },
    )
    .scan_chains();

    <span class="macro">info!</span>(<span class="string">&quot;scanned chains:&quot;</span>);
    <span class="macro">info!</span>(<span class="string">&quot;{}&quot;</span>, scan);

    spawn_context(<span class="kw-2">&amp;</span>config, <span class="kw-2">&amp;mut </span>registry.write(), <span class="kw-2">&amp;mut </span>workers.acquire_write()).spawn_workers(scan);

    <span class="kw">let </span>subscriptions = init_subscriptions(<span class="kw-2">&amp;</span>config, <span class="kw-2">&amp;mut </span>registry.write())<span class="question-mark">?</span>;

    <span class="kw">let </span>batch_tasks = spawn_batch_workers(
        <span class="kw-2">&amp;</span>config,
        registry.clone(),
        client_state_filter,
        workers.clone(),
        subscriptions,
    );

    <span class="kw">let </span>cmd_task = spawn_cmd_worker(registry.clone(), workers.clone(), cmd_rx);

    <span class="kw">let </span><span class="kw-2">mut </span>tasks = <span class="macro">vec!</span>[cmd_task];
    tasks.extend(batch_tasks);

    <span class="kw">if let </span><span class="prelude-val">Some</span>(rest_rx) = rest_rx {
        <span class="kw">let </span>rest_task = spawn_rest_worker(config, registry, workers, rest_rx);
        tasks.push(rest_task);
    }

    <span class="prelude-val">Ok</span>(tasks)
}

<span class="kw">fn </span>spawn_batch_workers&lt;Chain: ChainHandle&gt;(
    config: <span class="kw-2">&amp;</span>Config,
    registry: SharedRegistry&lt;Chain&gt;,
    client_state_filter: Arc&lt;RwLock&lt;FilterPolicy&gt;&gt;,
    workers: Arc&lt;RwLock&lt;WorkerMap&gt;&gt;,
    subscriptions: Vec&lt;(Chain, Subscription)&gt;,
) -&gt; Vec&lt;TaskHandle&gt; {
    <span class="kw">let </span><span class="kw-2">mut </span>handles = Vec::with_capacity(subscriptions.len());

    <span class="kw">for </span>(chain, subscription) <span class="kw">in </span>subscriptions {
        <span class="kw">let </span>config = config.clone();
        <span class="kw">let </span>registry = registry.clone();
        <span class="kw">let </span>client_state_filter = client_state_filter.clone();
        <span class="kw">let </span>workers = workers.clone();

        <span class="kw">let </span>handle = spawn_background_task(
            <span class="macro">error_span!</span>(<span class="string">&quot;worker.batch&quot;</span>, chain = %chain.id()),
            <span class="prelude-val">Some</span>(Duration::from_millis(<span class="number">5</span>)),
            <span class="kw">move </span>|| -&gt; <span class="prelude-ty">Result</span>&lt;Next, TaskError&lt;Infallible&gt;&gt; {
                <span class="kw">if let </span><span class="prelude-val">Ok</span>(batch) = subscription.try_recv() {
                    handle_batch(
                        <span class="kw-2">&amp;</span>config,
                        <span class="kw-2">&amp;mut </span>registry.write(),
                        <span class="kw-2">&amp;mut </span>client_state_filter.acquire_write(),
                        <span class="kw-2">&amp;mut </span>workers.acquire_write(),
                        chain.clone(),
                        batch,
                    );
                }

                <span class="prelude-val">Ok</span>(Next::Continue)
            },
        );

        handles.push(handle);
    }

    handles
}

<span class="kw">pub fn </span>spawn_cmd_worker&lt;Chain: ChainHandle&gt;(
    registry: SharedRegistry&lt;Chain&gt;,
    workers: Arc&lt;RwLock&lt;WorkerMap&gt;&gt;,
    cmd_rx: Receiver&lt;SupervisorCmd&gt;,
) -&gt; TaskHandle {
    spawn_background_task(
        <span class="macro">error_span!</span>(<span class="string">&quot;worker.cmd&quot;</span>),
        <span class="prelude-val">Some</span>(Duration::from_millis(<span class="number">500</span>)),
        <span class="kw">move </span>|| -&gt; <span class="prelude-ty">Result</span>&lt;Next, TaskError&lt;Infallible&gt;&gt; {
            <span class="kw">if let </span><span class="prelude-val">Ok</span>(cmd) = cmd_rx.try_recv() {
                <span class="kw">match </span>cmd {
                    SupervisorCmd::DumpState(reply_to) =&gt; {
                        dump_state(<span class="kw-2">&amp;</span>registry.read(), <span class="kw-2">&amp;</span>workers.acquire_read(), reply_to);
                    }
                }
            }

            <span class="prelude-val">Ok</span>(Next::Continue)
        },
    )
}

<span class="kw">pub fn </span>spawn_rest_worker&lt;Chain: ChainHandle&gt;(
    config: Config,
    registry: SharedRegistry&lt;Chain&gt;,
    workers: Arc&lt;RwLock&lt;WorkerMap&gt;&gt;,
    rest_rx: rest::Receiver,
) -&gt; TaskHandle {
    spawn_background_task(
        <span class="macro">error_span!</span>(<span class="string">&quot;rest&quot;</span>),
        <span class="prelude-val">Some</span>(Duration::from_millis(<span class="number">500</span>)),
        <span class="kw">move </span>|| -&gt; <span class="prelude-ty">Result</span>&lt;Next, TaskError&lt;Infallible&gt;&gt; {
            handle_rest_requests(<span class="kw-2">&amp;</span>config, <span class="kw-2">&amp;</span>registry.read(), <span class="kw-2">&amp;</span>workers.acquire_read(), <span class="kw-2">&amp;</span>rest_rx);

            <span class="prelude-val">Ok</span>(Next::Continue)
        },
    )
}

<span class="doccomment">/// Returns `true` if the relayer should filter based on
/// client state attributes, e.g., trust threshold.
/// Returns `false` otherwise.
</span><span class="kw">fn </span>client_filter_enabled(_config: <span class="kw-2">&amp;</span>Config) -&gt; bool {
    <span class="comment">// we currently always enable the client filter
    </span><span class="bool-val">true
</span>}

<span class="doccomment">/// Returns `true` if the relayer should filter based on
/// channel identifiers.
/// Returns `false` otherwise.
</span><span class="kw">fn </span>channel_filter_enabled(_config: <span class="kw-2">&amp;</span>Config) -&gt; bool {
    <span class="comment">// we currently always enable the channel filter
    </span><span class="bool-val">true
</span>}

<span class="doccomment">/// Whether or not the given channel is allowed by the filter policy, if any.
</span><span class="kw">fn </span>is_channel_allowed(
    config: <span class="kw-2">&amp;</span>Config,
    chain_id: <span class="kw-2">&amp;</span>ChainId,
    port_id: <span class="kw-2">&amp;</span>PortId,
    channel_id: <span class="kw-2">&amp;</span>ChannelId,
) -&gt; bool {
    <span class="comment">// If filtering is disabled, then relay all channels
    </span><span class="kw">if </span>!channel_filter_enabled(config) {
        <span class="kw">return </span><span class="bool-val">true</span>;
    }

    config.packets_on_channel_allowed(chain_id, port_id, channel_id)
}

<span class="doccomment">/// Whether or not the relayer should relay packets
/// or complete handshakes for the given [`Object`].
</span><span class="kw">fn </span>relay_on_object&lt;Chain: ChainHandle&gt;(
    config: <span class="kw-2">&amp;</span>Config,
    registry: <span class="kw-2">&amp;mut </span>Registry&lt;Chain&gt;,
    client_state_filter: <span class="kw-2">&amp;mut </span>FilterPolicy,
    chain_id: <span class="kw-2">&amp;</span>ChainId,
    object: <span class="kw-2">&amp;</span>Object,
) -&gt; bool {
    <span class="comment">// No filter is enabled, bail fast.
    </span><span class="kw">if </span>!channel_filter_enabled(config) &amp;&amp; !client_filter_enabled(config) {
        <span class="kw">return </span><span class="bool-val">true</span>;
    }

    <span class="comment">// First, apply the channel filter on packets and channel workers
    </span><span class="kw">match </span>object {
        Object::Packet(p) =&gt; {
            <span class="kw">if </span>!is_channel_allowed(config, chain_id, <span class="kw-2">&amp;</span>p.src_port_id, <span class="kw-2">&amp;</span>p.src_channel_id) {
                <span class="comment">// Forbid relaying packets on that channel
                </span><span class="kw">return </span><span class="bool-val">false</span>;
            }
        }
        Object::Channel(c) =&gt; {
            <span class="kw">if </span>!is_channel_allowed(config, chain_id, <span class="kw-2">&amp;</span>c.src_port_id, <span class="kw-2">&amp;</span>c.src_channel_id) {
                <span class="comment">// Forbid completing handshake for that channel
                </span><span class="kw">return </span><span class="bool-val">false</span>;
            }
        }
        <span class="kw">_ </span>=&gt; (),
    };

    <span class="comment">// Then, apply the client filter
    </span><span class="kw">let </span>client_filter_outcome = <span class="kw">match </span>object {
        Object::Client(client) =&gt; client_state_filter.control_client_object(registry, client),
        Object::Connection(conn) =&gt; client_state_filter.control_conn_object(registry, conn),
        Object::Channel(chan) =&gt; client_state_filter.control_chan_object(registry, chan),
        Object::Packet(packet) =&gt; client_state_filter.control_packet_object(registry, packet),
        Object::Wallet(_wallet) =&gt; <span class="prelude-val">Ok</span>(Permission::Allow),
    };

    <span class="kw">match </span>client_filter_outcome {
        <span class="prelude-val">Ok</span>(Permission::Allow) =&gt; <span class="bool-val">true</span>,
        <span class="prelude-val">Ok</span>(Permission::Deny) =&gt; {
            <span class="macro">warn!</span>(
                <span class="string">&quot;client filter denies relaying on object {}&quot;</span>,
                object.short_name()
            );

            <span class="bool-val">false
        </span>}
        <span class="prelude-val">Err</span>(e) <span class="kw">if </span>e.log_as_debug() =&gt; {
            <span class="macro">debug!</span>(
                <span class="string">&quot;denying relaying on object {}, caused by: {}&quot;</span>,
                object.short_name(),
                e
            );

            <span class="bool-val">false
        </span>}
        <span class="prelude-val">Err</span>(e) =&gt; {
            <span class="macro">warn!</span>(
                <span class="string">&quot;denying relaying on object {}, caused by: {}&quot;</span>,
                object.short_name(),
                e
            );

            <span class="bool-val">false
        </span>}
    }
}

<span class="doccomment">/// If `enabled`, build an `Object` using the provided `object_ctor`
/// and add the given `event` to the `collected` events for this `object`.
</span><span class="kw">fn </span>collect_event&lt;F&gt;(
    collected: <span class="kw-2">&amp;mut </span>CollectedEvents,
    event_with_height: IbcEventWithHeight,
    enabled: bool,
    object_ctor: F,
) <span class="kw">where
    </span>F: FnOnce() -&gt; <span class="prelude-ty">Option</span>&lt;Object&gt;,
{
    <span class="kw">if </span>enabled {
        <span class="kw">if let </span><span class="prelude-val">Some</span>(object) = object_ctor() {
            collected
                .per_object
                .entry(object)
                .or_default()
                .push(event_with_height);
        }
    }
}

<span class="kw">pub fn </span>collect_events(
    config: <span class="kw-2">&amp;</span>Config,
    workers: <span class="kw-2">&amp;</span>WorkerMap,
    src_chain: <span class="kw-2">&amp;</span><span class="kw">impl </span>ChainHandle,
    batch: <span class="kw-2">&amp;</span>EventBatch,
) -&gt; CollectedEvents {
    <span class="kw">let </span><span class="kw-2">mut </span>collected =
        CollectedEvents::new(batch.height, batch.chain_id.clone(), batch.tracking_id);

    <span class="kw">let </span>mode = config.mode;

    <span class="kw">for </span>event_with_height <span class="kw">in </span><span class="kw-2">&amp;</span>batch.events {
        <span class="kw">match </span><span class="kw-2">&amp;</span>event_with_height.event {
            IbcEvent::NewBlock(<span class="kw">_</span>) =&gt; {
                collected.new_block = <span class="prelude-val">Some</span>(event_with_height.event.clone());
            }
            IbcEvent::UpdateClient(update) =&gt; {
                collect_event(
                    <span class="kw-2">&amp;mut </span>collected,
                    event_with_height.clone(),
                    mode.clients.enabled,
                    || {
                        <span class="comment">// Collect update client events only if the worker exists
                        </span><span class="kw">if let </span><span class="prelude-val">Ok</span>(object) = Object::for_update_client(update, src_chain) {
                            workers.contains(<span class="kw-2">&amp;</span>object).then_some(object)
                        } <span class="kw">else </span>{
                            <span class="prelude-val">None
                        </span>}
                    },
                );
            }
            IbcEvent::OpenInitConnection(..)
            | IbcEvent::OpenTryConnection(..)
            | IbcEvent::OpenAckConnection(..) =&gt; {
                collect_event(
                    <span class="kw-2">&amp;mut </span>collected,
                    event_with_height.clone(),
                    mode.connections.enabled,
                    || {
                        event_with_height
                            .event
                            .connection_attributes()
                            .and_then(|attr| {
                                Object::connection_from_conn_open_events(attr, src_chain).ok()
                            })
                    },
                );
            }
            IbcEvent::OpenInitChannel(..) | IbcEvent::OpenTryChannel(..) =&gt; {
                collect_event(
                    <span class="kw-2">&amp;mut </span>collected,
                    event_with_height.clone(),
                    mode.channels.enabled,
                    || {
                        event_with_height
                            .event
                            .clone()
                            .channel_attributes()
                            .and_then(|attr| {
                                Object::channel_from_chan_open_events(<span class="kw-2">&amp;</span>attr, src_chain).ok()
                            })
                    },
                );
            }
            IbcEvent::OpenAckChannel(open_ack) =&gt; {
                <span class="comment">// Create client and packet workers here as channel end must be opened
                </span><span class="kw">let </span>attributes = open_ack.clone().into();
                collect_event(
                    <span class="kw-2">&amp;mut </span>collected,
                    event_with_height.clone(),
                    mode.clients.enabled,
                    || Object::client_from_chan_open_events(<span class="kw-2">&amp;</span>attributes, src_chain).ok(),
                );

                <span class="comment">// If handshake message relaying is enabled create worker to send the MsgChannelOpenConfirm message
                </span>collect_event(
                    <span class="kw-2">&amp;mut </span>collected,
                    event_with_height.clone(),
                    mode.channels.enabled,
                    || Object::channel_from_chan_open_events(<span class="kw-2">&amp;</span>attributes, src_chain).ok(),
                );
            }
            IbcEvent::OpenConfirmChannel(open_confirm) =&gt; {
                <span class="kw">let </span>attributes = open_confirm.clone().into();
                <span class="comment">// Create client worker here as channel end must be opened
                </span>collect_event(
                    <span class="kw-2">&amp;mut </span>collected,
                    event_with_height.clone(),
                    mode.clients.enabled,
                    || Object::client_from_chan_open_events(<span class="kw-2">&amp;</span>attributes, src_chain).ok(),
                );
            }
            IbcEvent::SendPacket(<span class="kw-2">ref </span>packet) =&gt; {
                collect_event(
                    <span class="kw-2">&amp;mut </span>collected,
                    event_with_height.clone(),
                    mode.packets.enabled,
                    || Object::for_send_packet(packet, src_chain).ok(),
                );
            }
            IbcEvent::TimeoutPacket(<span class="kw-2">ref </span>packet) =&gt; {
                collect_event(
                    <span class="kw-2">&amp;mut </span>collected,
                    event_with_height.clone(),
                    mode.packets.enabled,
                    || Object::for_timeout_packet(packet, src_chain).ok(),
                );
            }
            IbcEvent::WriteAcknowledgement(<span class="kw-2">ref </span>packet) =&gt; {
                collect_event(
                    <span class="kw-2">&amp;mut </span>collected,
                    event_with_height.clone(),
                    mode.packets.enabled,
                    || Object::for_write_ack(packet, src_chain).ok(),
                );
            }
            IbcEvent::CloseInitChannel(<span class="kw-2">ref </span>packet) =&gt; {
                collect_event(
                    <span class="kw-2">&amp;mut </span>collected,
                    event_with_height.clone(),
                    mode.packets.enabled,
                    || Object::for_close_init_channel(packet, src_chain).ok(),
                );
            }
            <span class="kw">_ </span>=&gt; (),
        }
    }

    collected
}

<span class="doccomment">/// Create a new `SpawnContext` for spawning workers.
</span><span class="kw">fn </span>spawn_context&lt;<span class="lifetime">&#39;a</span>, Chain: ChainHandle&gt;(
    config: <span class="kw-2">&amp;</span><span class="lifetime">&#39;a </span>Config,
    registry: <span class="kw-2">&amp;</span><span class="lifetime">&#39;a </span><span class="kw-2">mut </span>Registry&lt;Chain&gt;,
    workers: <span class="kw-2">&amp;</span><span class="lifetime">&#39;a </span><span class="kw-2">mut </span>WorkerMap,
) -&gt; SpawnContext&lt;<span class="lifetime">&#39;a</span>, Chain&gt; {
    SpawnContext::new(config, registry, workers)
}

<span class="kw">fn </span>chain_scanner&lt;<span class="lifetime">&#39;a</span>, Chain: ChainHandle&gt;(
    config: <span class="kw-2">&amp;</span><span class="lifetime">&#39;a </span>Config,
    registry: <span class="kw-2">&amp;</span><span class="lifetime">&#39;a </span><span class="kw-2">mut </span>Registry&lt;Chain&gt;,
    client_state_filter: <span class="kw-2">&amp;</span><span class="lifetime">&#39;a </span><span class="kw-2">mut </span>FilterPolicy,
    full_scan: ScanMode,
) -&gt; ChainScanner&lt;<span class="lifetime">&#39;a</span>, Chain&gt; {
    ChainScanner::new(config, registry, client_state_filter, full_scan)
}

<span class="doccomment">/// Perform a health check on all connected chains
</span><span class="kw">fn </span>health_check&lt;Chain: ChainHandle&gt;(config: <span class="kw-2">&amp;</span>Config, registry: <span class="kw-2">&amp;mut </span>Registry&lt;Chain&gt;) {
    <span class="kw">use </span>HealthCheck::<span class="kw-2">*</span>;

    <span class="kw">let </span>chains = <span class="kw-2">&amp;</span>config.chains;

    <span class="kw">for </span>config <span class="kw">in </span>chains {
        <span class="kw">let </span>id = <span class="kw-2">&amp;</span>config.id;
        <span class="kw">let </span>_span = <span class="macro">error_span!</span>(<span class="string">&quot;health_check&quot;</span>, chain = %id).entered();

        <span class="kw">let </span>chain = registry.get_or_spawn(id);

        <span class="kw">match </span>chain {
            <span class="prelude-val">Ok</span>(chain) =&gt; <span class="kw">match </span>chain.health_check() {
                <span class="prelude-val">Ok</span>(Healthy) =&gt; <span class="macro">info!</span>(<span class="string">&quot;chain is healthy&quot;</span>),
                <span class="prelude-val">Ok</span>(Unhealthy(e)) =&gt; <span class="macro">warn!</span>(<span class="string">&quot;chain is not healthy: {}&quot;</span>, e),
                <span class="prelude-val">Err</span>(e) =&gt; <span class="macro">error!</span>(<span class="string">&quot;failed to perform health check: {}&quot;</span>, e),
            },
            <span class="prelude-val">Err</span>(e) =&gt; {
                <span class="macro">error!</span>(
                    <span class="string">&quot;skipping health check, reason: failed to spawn chain runtime with error: {}&quot;</span>,
                    e
                );
            }
        }
    }
}

<span class="doccomment">/// Subscribe to the events emitted by the chains the supervisor is connected to.
</span><span class="attribute">#[instrument(name = <span class="string">&quot;supervisor.init_subscriptions&quot;</span>, level = <span class="string">&quot;error&quot;</span>, skip_all)]
</span><span class="kw">fn </span>init_subscriptions&lt;Chain: ChainHandle&gt;(
    config: <span class="kw-2">&amp;</span>Config,
    registry: <span class="kw-2">&amp;mut </span>Registry&lt;Chain&gt;,
) -&gt; <span class="prelude-ty">Result</span>&lt;Vec&lt;(Chain, Subscription)&gt;, Error&gt; {
    <span class="kw">let </span>chains = <span class="kw-2">&amp;</span>config.chains;

    <span class="kw">let </span><span class="kw-2">mut </span>subscriptions = Vec::with_capacity(chains.len());

    <span class="kw">for </span>chain_config <span class="kw">in </span>chains {
        <span class="kw">let </span>chain = <span class="kw">match </span>registry.get_or_spawn(<span class="kw-2">&amp;</span>chain_config.id) {
            <span class="prelude-val">Ok</span>(chain) =&gt; chain,
            <span class="prelude-val">Err</span>(e) =&gt; {
                <span class="macro">error!</span>(
                    <span class="string">&quot;failed to spawn chain runtime for {}: {}&quot;</span>,
                    chain_config.id, e
                );

                <span class="kw">continue</span>;
            }
        };

        <span class="kw">match </span>chain.subscribe() {
            <span class="prelude-val">Ok</span>(subscription) =&gt; subscriptions.push((chain, subscription)),
            <span class="prelude-val">Err</span>(e) =&gt; <span class="macro">error!</span>(
                <span class="string">&quot;failed to subscribe to events of {}: {}&quot;</span>,
                chain_config.id, e
            ),
        }
    }

    <span class="comment">// At least one chain runtime should be available, otherwise the supervisor
    // cannot do anything and will hang indefinitely.
    </span><span class="kw">if </span>registry.size() == <span class="number">0 </span>{
        <span class="kw">return </span><span class="prelude-val">Err</span>(Error::no_chains_available());
    }

    <span class="prelude-val">Ok</span>(subscriptions)
}

<span class="doccomment">/// Dump the state of the supervisor into a [`SupervisorState`] value,
/// and send it back through the given channel.
</span><span class="kw">fn </span>dump_state&lt;Chain: ChainHandle&gt;(
    registry: <span class="kw-2">&amp;</span>Registry&lt;Chain&gt;,
    workers: <span class="kw-2">&amp;</span>WorkerMap,
    reply_to: Sender&lt;SupervisorState&gt;,
) {
    <span class="kw">let </span>state = state(registry, workers);
    <span class="kw">let _ </span>= reply_to.try_send(state);
}

<span class="doccomment">/// Returns a representation of the supervisor&#39;s internal state
/// as a [`SupervisorState`].
</span><span class="kw">fn </span>state&lt;Chain: ChainHandle&gt;(registry: <span class="kw-2">&amp;</span>Registry&lt;Chain&gt;, workers: <span class="kw-2">&amp;</span>WorkerMap) -&gt; SupervisorState {
    <span class="kw">let </span>chains = registry.chains().map(|c| c.id()).collect_vec();
    SupervisorState::new(chains, workers.handles())
}

<span class="kw">fn </span>handle_rest_requests&lt;Chain: ChainHandle&gt;(
    config: <span class="kw-2">&amp;</span>Config,
    registry: <span class="kw-2">&amp;</span>Registry&lt;Chain&gt;,
    workers: <span class="kw-2">&amp;</span>WorkerMap,
    rest_rx: <span class="kw-2">&amp;</span>rest::Receiver,
) {
    <span class="kw">if let </span><span class="prelude-val">Some</span>(cmd) = rest::process_incoming_requests(config, rest_rx) {
        handle_rest_cmd(registry, workers, cmd);
    }
}

<span class="attribute">#[instrument(name = <span class="string">&quot;supervisor.handle_rest_cmd&quot;</span>, level = <span class="string">&quot;error&quot;</span>, skip_all)]
</span><span class="kw">fn </span>handle_rest_cmd&lt;Chain: ChainHandle&gt;(
    registry: <span class="kw-2">&amp;</span>Registry&lt;Chain&gt;,
    workers: <span class="kw-2">&amp;</span>WorkerMap,
    m: rest::Command,
) {
    <span class="kw">match </span>m {
        rest::Command::DumpState(reply) =&gt; {
            <span class="kw">let </span>state = state(registry, workers);
            reply
                .send(<span class="prelude-val">Ok</span>(state))
                .unwrap_or_else(|e| <span class="macro">error!</span>(<span class="string">&quot;error replying to a REST request {}&quot;</span>, e));
        }
    }
}

<span class="attribute">#[instrument(
    name = <span class="string">&quot;supervisor.clear_pending_packets&quot;</span>,
    level = <span class="string">&quot;error&quot;</span>,
    skip_all,
    fields(chain = %chain_id)
)]
</span><span class="kw">fn </span>clear_pending_packets(workers: <span class="kw-2">&amp;mut </span>WorkerMap, chain_id: <span class="kw-2">&amp;</span>ChainId) -&gt; <span class="prelude-ty">Result</span>&lt;(), Error&gt; {
    <span class="kw">for </span>worker <span class="kw">in </span>workers.workers_for_chain(chain_id) {
        worker.clear_pending_packets();
    }

    <span class="prelude-val">Ok</span>(())
}

<span class="doccomment">/// Process a batch of events received from a chain.
</span><span class="attribute">#[instrument(
    name = <span class="string">&quot;supervisor.process_batch&quot;</span>,
    level = <span class="string">&quot;error&quot;</span>,
    skip_all,
    fields(chain = %src_chain.id()))
]
</span><span class="kw">fn </span>process_batch&lt;Chain: ChainHandle&gt;(
    config: <span class="kw-2">&amp;</span>Config,
    registry: <span class="kw-2">&amp;mut </span>Registry&lt;Chain&gt;,
    client_state_filter: <span class="kw-2">&amp;mut </span>FilterPolicy,
    workers: <span class="kw-2">&amp;mut </span>WorkerMap,
    src_chain: Chain,
    batch: <span class="kw-2">&amp;</span>EventBatch,
) -&gt; <span class="prelude-ty">Result</span>&lt;(), Error&gt; {
    <span class="macro">assert_eq!</span>(src_chain.id(), batch.chain_id);

    <span class="macro">telemetry!</span>(received_event_batch, batch.tracking_id);

    <span class="kw">let </span>collected = collect_events(config, workers, <span class="kw-2">&amp;</span>src_chain, batch);

    <span class="comment">// If there is a NewBlock event, forward this event first to any workers affected by it.
    </span><span class="kw">if let </span><span class="prelude-val">Some</span>(IbcEvent::NewBlock(new_block)) = collected.new_block {
        workers.notify_new_block(<span class="kw-2">&amp;</span>src_chain.id(), batch.height, new_block);
    }

    <span class="comment">// Forward the IBC events.
    </span><span class="kw">for </span>(object, events_with_heights) <span class="kw">in </span>collected.per_object.into_iter() {
        <span class="kw">if </span>!relay_on_object(
            config,
            registry,
            client_state_filter,
            <span class="kw-2">&amp;</span>src_chain.id(),
            <span class="kw-2">&amp;</span>object,
        ) {
            <span class="macro">trace!</span>(
                <span class="string">&quot;skipping events for &#39;{}&#39;. \
                reason: filtering is enabled and channel does not match any allowed channels&quot;</span>,
                object.short_name()
            );

            <span class="kw">continue</span>;
        }

        <span class="kw">if </span>events_with_heights.is_empty() {
            <span class="kw">continue</span>;
        }

        <span class="kw">let </span>src = registry
            .get_or_spawn(object.src_chain_id())
            .map_err(Error::spawn)<span class="question-mark">?</span>;

        <span class="kw">let </span>dst = registry
            .get_or_spawn(object.dst_chain_id())
            .map_err(Error::spawn)<span class="question-mark">?</span>;

        <span class="kw">if let </span>Object::Packet(<span class="kw-2">ref </span>_path) = object {
            <span class="comment">// Update telemetry info
            </span><span class="macro">telemetry!</span>(send_telemetry(<span class="kw-2">&amp;</span>src, <span class="kw-2">&amp;</span>dst, <span class="kw-2">&amp;</span>events_with_heights, _path));
        }

        <span class="kw">let </span>worker = workers.get_or_spawn(object, src, dst, config);

        worker.send_events(
            batch.height,
            events_with_heights,
            batch.chain_id.clone(),
            batch.tracking_id,
        );
    }

    <span class="prelude-val">Ok</span>(())
}

<span class="doccomment">/// This method parses a list of IbcEvent and record the following three metrics if there is
/// the corresponding event:
/// * send_packet_events: The number of SendPacket events received
/// * acknowledgement_events: The number of WriteAcknowledgment events received.
/// * timeout_events: The number of TimeoutPacket events received.
///
/// The labels `chain_id` represents the chain sending the event, and `counterparty_chain_id` represents
/// the chain receiving the event.
/// So successfully sending a packet from chain A to chain B will result in first a SendPacket
/// event with `chain_id = A` and `counterparty_chain_id = B` and then a WriteAcknowlegment
/// event with `chain_id = B` and `counterparty_chain_id = A`.
</span><span class="attribute">#[cfg(feature = <span class="string">&quot;telemetry&quot;</span>)]
</span><span class="kw">fn </span>send_telemetry&lt;Src, Dst&gt;(
    src: <span class="kw-2">&amp;</span>Src,
    dst: <span class="kw-2">&amp;</span>Dst,
    events: <span class="kw-2">&amp;</span>[IbcEventWithHeight],
    path: <span class="kw-2">&amp;</span><span class="kw">crate</span>::object::Packet,
) <span class="kw">where
    </span>Src: ChainHandle,
    Dst: ChainHandle,
{
    <span class="macro">telemetry! </span>{
        <span class="kw">for </span>e <span class="kw">in </span>events {
            <span class="kw">match </span>e.event.clone() {
                IbcEvent::SendPacket(send_packet_ev) =&gt; {
                    ibc_telemetry::global().send_packet_events(
                        send_packet_ev.packet.sequence.into(),
                        e.height.revision_height(),
                        <span class="kw-2">&amp;</span>src.id(),
                        <span class="kw-2">&amp;</span>path.src_channel_id,
                        <span class="kw-2">&amp;</span>path.src_port_id,
                        <span class="kw-2">&amp;</span>dst.id(),
                    );
                }
                IbcEvent::WriteAcknowledgement(write_ack_ev) =&gt; {
                    ibc_telemetry::global().acknowledgement_events(
                        write_ack_ev.packet.sequence.into(),
                        e.height.revision_height(),
                        <span class="kw-2">&amp;</span>src.id(),
                        <span class="kw-2">&amp;</span>path.src_channel_id,
                        <span class="kw-2">&amp;</span>path.src_port_id,
                        <span class="kw-2">&amp;</span>dst.id(),
                    );
                }
                IbcEvent::TimeoutPacket(<span class="kw">_</span>) =&gt; {
                    ibc_telemetry::global().timeout_events(
                        <span class="kw-2">&amp;</span>src.id(),
                        <span class="kw-2">&amp;</span>path.src_channel_id,
                        <span class="kw-2">&amp;</span>path.src_port_id,
                        <span class="kw-2">&amp;</span>dst.id(),
                    );
                }
                <span class="kw">_ </span>=&gt; {}
            }
        }
    }
}

<span class="doccomment">/// Process the given batch if it does not contain any errors,
/// output the errors on the console otherwise.
</span><span class="attribute">#[instrument(
    name = <span class="string">&quot;supervisor.handle_batch&quot;</span>,
    level = <span class="string">&quot;error&quot;</span>,
    skip_all,
    fields(chain = %chain.id())
)]
</span><span class="kw">fn </span>handle_batch&lt;Chain: ChainHandle&gt;(
    config: <span class="kw-2">&amp;</span>Config,
    registry: <span class="kw-2">&amp;mut </span>Registry&lt;Chain&gt;,
    client_state_filter: <span class="kw-2">&amp;mut </span>FilterPolicy,
    workers: <span class="kw-2">&amp;mut </span>WorkerMap,
    chain: Chain,
    batch: ArcBatch,
) {
    <span class="kw">let </span>chain_id = chain.id();

    <span class="kw">match </span>batch.deref() {
        <span class="prelude-val">Ok</span>(batch) =&gt; {
            <span class="kw">if let </span><span class="prelude-val">Err</span>(e) =
                process_batch(config, registry, client_state_filter, workers, chain, batch)
            {
                <span class="macro">error!</span>(<span class="string">&quot;error during batch processing: {}&quot;</span>, e);
            }
        }
        <span class="prelude-val">Err</span>(EventError(EventErrorDetail::SubscriptionCancelled(<span class="kw">_</span>), <span class="kw">_</span>)) =&gt; {
            <span class="macro">warn!</span>(<span class="string">&quot;event subscription was cancelled, clearing pending packets&quot;</span>);

            <span class="kw">let _ </span>= clear_pending_packets(workers, <span class="kw-2">&amp;</span>chain_id)
                .map_err(|e| <span class="macro">error!</span>(<span class="string">&quot;error during clearing pending packets: {}&quot;</span>, e));
        }
        <span class="prelude-val">Err</span>(e) =&gt; {
            <span class="macro">error!</span>(<span class="string">&quot;error when receiving event batch: {}&quot;</span>, e)
        }
    }
}

<span class="doccomment">/// Describes the result of [`collect_events`].
</span><span class="attribute">#[derive(Clone, Debug)]
</span><span class="kw">pub struct </span>CollectedEvents {
    <span class="doccomment">/// The height at which these events were emitted from the chain.
    </span><span class="kw">pub </span>height: Height,
    <span class="doccomment">/// The chain from which the events were emitted.
    </span><span class="kw">pub </span>chain_id: ChainId,
    <span class="doccomment">/// [`NewBlock`](ibc_relayer_types::events::IbcEventType::NewBlock) event
    /// collected from the [`EventBatch`].
    </span><span class="kw">pub </span>new_block: <span class="prelude-ty">Option</span>&lt;IbcEvent&gt;,
    <span class="doccomment">/// Mapping between [`Object`]s and their associated [`IbcEvent`]s.
    </span><span class="kw">pub </span>per_object: HashMap&lt;Object, Vec&lt;IbcEventWithHeight&gt;&gt;,
    <span class="doccomment">/// Unique identifier for tracking this event batch
    </span><span class="kw">pub </span>tracking_id: TrackingId,
}

<span class="kw">impl </span>CollectedEvents {
    <span class="kw">pub fn </span>new(height: Height, chain_id: ChainId, tracking_id: TrackingId) -&gt; <span class="self">Self </span>{
        <span class="self">Self </span>{
            height,
            chain_id,
            tracking_id,
            new_block: Default::default(),
            per_object: Default::default(),
        }
    }

    <span class="doccomment">/// Whether the collected events include a
    /// [`NewBlock`](ibc_relayer_types::events::IbcEventType::NewBlock) event.
    </span><span class="kw">pub fn </span>has_new_block(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; bool {
        <span class="self">self</span>.new_block.is_some()
    }
}
</code></pre></div>
</section></div></main><div id="rustdoc-vars" data-root-path="../../" data-current-crate="ibc_relayer" data-themes="ayu,dark,light" data-resource-suffix="" data-rustdoc-version="1.65.0 (897e37553 2022-11-02)" ></div></body></html>